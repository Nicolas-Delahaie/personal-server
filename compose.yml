services:
  glances:
    image: nicolargo/glances
    volumes:
      - ./glances.conf:/glances/conf/glances.conf
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - GLANCES_OPT=-C /glances/conf/glances.conf -w
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.glances.rule=Host(`glances.${HOSTNAME}`)"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"
      - "traefik.http.routers.glances.entrypoints=web"
      - "traefik.http.routers.glances.middlewares=auth@file"

  portainer:
    build:
      context: ./portainer
      args:
        - PORTAINER_ADMIN_PASSWORD=${PORTAINER_ADMIN_PASSWORD}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${HOSTNAME}`)"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.routers.portainer.entrypoints=web"

  traefik:
    build:
      context: ./traefik
      args:
        - TRAEFIK_USER=${TRAEFIK_USER}
        - TRAEFIK_PASSWORD=${TRAEFIK_PASSWORD}
        - PASSWORD_FILE_PATH=/auth/usersfile
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic_conf.yml:/etc/traefik/dynamic_conf.yml:ro
    ports:
      - 80:80
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${HOSTNAME}`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth@file"
  odoo:
    build:
      context: ./odoo
      args:
        - ODOO_MASTER_PASSWORD=${ODOO_MASTER_PASSWORD}
        - ODOO_DATABASE_NAME=${ODOO_DATABASE_NAME}
    depends_on:
      - odoo-db
    environment:
      - HOST=odoo-db
      - USER=${ODOO_DB_USER}
      - PASSWORD=${ODOO_DB_PASSWORD}
    volumes:
      - odoo_addons:/mnt/extra-addons
      - odoo_web_data:/var/lib/odoo
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.odoo.rule=Host(`odoo.${HOSTNAME}`)"
      - "traefik.http.services.odoo.loadbalancer.server.port=8069"
      - "traefik.http.routers.odoo.entrypoints=web"

  odoo-db:
    image: postgres
    environment:
      - POSTGRES_DB=${ODOO_DATABASE_NAME}
      - POSTGRES_USER=${ODOO_DB_USER}
      - POSTGRES_PASSWORD=${ODOO_DB_PASSWORD}
    volumes:
      - odoo_datas:/var/lib/postgresql/data

volumes:
  portainer_data:
  odoo_datas:
  odoo_web_data:
  odoo_addons:
