services:
  glances:
    image: nicolargo/glances
    volumes:
      - ./glances.conf:/glances/conf/glances.conf
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - GLANCES_OPT=-C /glances/conf/glances.conf -w
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.glances.rule=Host(`glances.${DOMAIN}`)"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"
      - "traefik.http.routers.glances.entrypoints=web"
      - "traefik.http.routers.glances.middlewares=auth@docker"

  portainer:
    image: portainer/portainer-ce
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${DOMAIN}`)"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.routers.portainer.entrypoints=web"

  traefik:
    build:
      context: ./traefik
      args:
        - TRAEFIK_USER=${TRAEFIK_USER}
        - TRAEFIK_PASSWORD=${TRAEFIK_PASSWORD}
        - PASSWORD_FILE_PATH=/auth/usersfile
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--api.debug=true"
    ports:
      - 80:80
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.nicolas-delahaie.fr`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth@docker"
      - "traefik.http.middlewares.auth.basicauth.usersFile=/auth/usersfile"

volumes:
  portainer_data:
