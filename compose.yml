services:
  traefik:
    image: traefik:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik_template.yml:/etc/traefik/traefik_template.yml:ro
      - ./traefik/traefik_dynamic.yml:${TRAEFIK_DYNAMIC_CONF}:ro
      - ./traefik/entrypoint.sh:/entrypoint.sh:ro
      - ./traefik/logs:/logs
      - traefik_certs:/acme
    environment:
      - LOG_LEVEL=info # Increasing logs (default is warning)
      - DEBUG_MODE=false
      - DOMAIN
      - LETSENCRYPT_EMAIL
      - TRAEFIK_DYNAMIC_CONF
      - OVH_ENDPOINT=ovh-eu
      - OVH_APPLICATION_KEY
      - OVH_APPLICATION_SECRET
      - OVH_CONSUMER_KEY
    ports:
      - 80:80
      - 443:443
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      traefik.enable: true
      traefik.http.middlewares.auth.basicAuth.users: ${TRAEFIK_ADMIN_TOKEN}
      traefik.http.routers.traefik.service: api@internal
      traefik.http.routers.traefik.middlewares: auth,errp-redirect@file
      traefik.http.routers.traefik.tls.certResolver: letsencrypt
      traefik.http.routers.traefik.tls.domains[0].main: "${DOMAIN}"
      traefik.http.routers.traefik.tls.domains[0].sans: "*.${DOMAIN}"
    depends_on:
      errp:
        condition: service_healthy

  glances:
    image: nicolargo/glances
    volumes:
      - ./glances/glances.conf:/glances/conf/glances.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - GLANCES_OPT=-C /glances/conf/glances.conf -w
    labels:
      traefik.enable: true
      traefik.http.routers.glances.middlewares: auth,errp-redirect@file
    pid: host
    profiles:
      - monitoring

  portainer:
    image: portainer/portainer-ce:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      traefik.enable: true
      traefik.http.services.portainer.loadbalancer.server.port: 9000
      traefik.http.routers.portainer.middlewares: errp-redirect@file
    command: ["--admin-password", "${PORTAINER_ADMIN_PASSWORD}"]
    profiles:
      - monitoring

  ha:
    image: ghcr.io/home-assistant/home-assistant:latest
    volumes:
      - ./ha/config:/config
    network_mode: host # Only for Linux, usefull for MDNS discovery
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - LOCAL_IP
      - EXTERNAL_URL=https://ha.${DOMAIN}
    labels:
      traefik.enable: true
      traefik.http.services.ha.loadbalancer.server.url: http://host.docker.internal:8123
      traefik.http.routers.ha.middlewares: errp-redirect@file
    depends_on:
      - mosquitto

  z2m:
    image: koenkk/zigbee2mqtt
    volumes:
      - ./z2m/data:/app/data
    devices:
      - /dev/serial/by-id/${ZIGBEE_USB}:/dev/ttyUSB0
    environment:
      - ZIGBEE2MQTT_CONFIG_ADVANCED_LOG_LEVEL=warning # Decreasing logs (default is info)
    labels:
      traefik.enable: true
      traefik.http.routers.z2m.middlewares: auth,errp-redirect@file
      traefik.http.services.z2m.loadbalancer.server.port: 8080
    depends_on:
      - mosquitto

  mosquitto:
    image: eclipse-mosquitto
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    ports:
      - 127.0.0.1:1883:1883 # Necessary for HA, which is not on the same network

  vw:
    image: vaultwarden/server:latest
    volumes:
      - vw_data:/data
    env_file: ./vw/.env
    environment:
      # Static configuration here : /vw/.env
      - DOMAIN=https://vw.${DOMAIN}
      - ADMIN_TOKEN=${VW_ADMIN_TOKEN}
      - PUSH_INSTALLATION_ID
      - PUSH_INSTALLATION_KEY
    healthcheck:
      start_period: 5s
    labels:
      traefik.enable: true
      traefik.http.routers.vw.middlewares: secure-headers@file

  errp:
    image: ghcr.io/tarampampam/error-pages:latest
    environment:
      TEMPLATE_NAME: win98 #cats,win98,shuffle,connection
    labels:
      traefik.enable: true
      traefik.http.routers.errp.middlewares: errp-redirect@file
      # Fallback router
      traefik.http.routers.errp.rule: HostRegexp(`.+`)
      traefik.http.routers.errp.priority: 10
      traefik.http.services.errp.loadbalancer.server.port: 8080

  simcom:
    build: ./simcom
    volumes:
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket
      - ./simcom/src:/app
    devices:
      - /dev/serial/by-id/${SIMCOM_DONGLE}:/dev/ttyUSB1
    depends_on:
      - mosquitto

volumes:
  vw_data:
  portainer_data:
  traefik_certs:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: ${LOCAL_IP}
