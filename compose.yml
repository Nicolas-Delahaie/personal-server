services:
  traefik:
    image: traefik:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik_static_template.yml:/etc/traefik/traefik_static_template.yml:ro
      - ./traefik/traefik_dynamic.yml:${TRAEFIK_DYNAMIC_CONF}:ro
      - ./traefik/entrypoint.sh:/entrypoint.sh:ro
      - ./traefik/logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - traefik_certs:/acme
    environment:
      - LOG_LEVEL=info # Increasing logs (default is warning)
      - DEBUG_MODE=false
      - DOMAIN
      - LETSENCRYPT_EMAIL
      - TRAEFIK_DYNAMIC_CONF
      - OVH_ENDPOINT=ovh-eu
      - OVH_APPLICATION_KEY
      - OVH_APPLICATION_SECRET
      - OVH_CONSUMER_KEY
    ports:
      - 443:443
    extra_hosts:
      - "server-host:host-gateway"
    labels:
      traefik.enable: true
      traefik.http.routers.traefik.service: api@internal
      traefik.http.routers.traefik.middlewares: authelia@file,errp-redirect@file
    depends_on:
      cs:
        condition: service_started
      errp:
        condition: service_healthy
      authelia:
        condition: service_healthy

  authelia:
    image: authelia/authelia:latest
    environment:
      - AUTHELIA_STORAGE_ENCRYPTION_KEY
      - DOMAIN
      - X_AUTHELIA_CONFIG_FILTERS=template # For dynamic use of "env"
    volumes:
      - ./authelia/config:/config
    labels:
      traefik.enable: true

  glances:
    image: nicolargo/glances:latest
    volumes:
      - ./glances/glances.conf:/etc/glances/glances.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - GLANCES_OPT=-w
    labels:
      traefik.enable: true
      traefik.http.routers.glances.middlewares: authelia@file,errp-redirect@file
      traefik.http.services.glances.loadbalancer.server.url: http://server-host:61208
    network_mode: host
    pid: host

  portainer:
    image: portainer/portainer-ce:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      traefik.enable: true
      traefik.http.services.portainer.loadbalancer.server.port: 9000
      traefik.http.routers.portainer.middlewares: errp-redirect@file
    command: ["--admin-password", "${PORTAINER_ADMIN_PASSWORD}"]
    ports:
      - 127.0.0.1:9000:9000 # Necessary for HA, which is not on the same network

  ha:
    image: ghcr.io/home-assistant/home-assistant:latest
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./ha/config:/config
    network_mode: host # Only for Linux, usefull for MDNS discovery
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - SUBNET_IP
      - INTERNAL_URL=http://${LOCAL_DOMAIN}:8123
      - EXTERNAL_URL=https://ha.${DOMAIN}
    labels:
      traefik.enable: true
      traefik.http.services.ha.loadbalancer.server.url: http://server-host:8123
      traefik.http.routers.ha.middlewares: errp-redirect@file
    depends_on:
      - mosquitto

  z2m:
    image: koenkk/zigbee2mqtt
    volumes:
      - ./z2m/data:/app/data
    devices:
      - /dev/serial/by-id/${ZIGBEE_USB}:/dev/ttyUSB0
    environment:
      - ZIGBEE2MQTT_CONFIG_ADVANCED_LOG_LEVEL=warning # Decreasing logs (default is info)
    labels:
      traefik.enable: true
      traefik.http.routers.z2m.middlewares: authelia@file,errp-redirect@file
      traefik.http.services.z2m.loadbalancer.server.port: 8080
    depends_on:
      - mosquitto

  mosquitto:
    image: eclipse-mosquitto
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 127.0.0.1:1883:1883 # Necessary for HA, which is not on the same network

  vw:
    image: vaultwarden/server:latest
    volumes:
      - vw_data:/data
      - /etc/localtime:/etc/localtime:ro
    env_file: ./vw/.env # Static configuration
    environment: # Dynamic configuration
      - DOMAIN=https://vw.${DOMAIN}
      - ADMIN_TOKEN=${VW_ADMIN_TOKEN}
      - PUSH_INSTALLATION_ID
      - PUSH_INSTALLATION_KEY
    healthcheck:
      start_period: 5s
    labels:
      traefik.enable: true
      traefik.http.routers.vw.middlewares: secure-headers@file

  errp:
    image: ghcr.io/tarampampam/error-pages:latest
    environment:
      - TEMPLATE_NAME=win98 #cats,win98,shuffle,connection
    labels:
      traefik.enable: true
      traefik.http.routers.errp.middlewares: errp-redirect@file
      # Fallback router
      traefik.http.routers.errp.rule: HostRegexp(`.+`)
      traefik.http.routers.errp.priority: 10
      traefik.http.services.errp.loadbalancer.server.port: 8080

  # simcom:
  #   build: ./simcom
  #   volumes:
  #     - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket
  #     - ./simcom/src:/app
  #   devices:
  #     - /dev/serial/by-id/${SIMCOM_DONGLE}:/dev/ttyUSB1
  #   depends_on:
  #     - mosquitto

  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    stop_grace_period: 30s # Frigate is long to quit
    shm_size: "256mb"
    privileged: true # Necessary for GPU acceleration
    extra_hosts:
      - "camera-1:${CAM1_IP}"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./frigate/config:/config
      - ./frigate/media:/media/frigate
      - type: tmpfs # Optional: 1GB of memory, reduces SSD/SD Card wear
        target: /tmp/cache
        tmpfs:
          size: 1000000000
    ports:
      - "127.0.0.1:5000:5000" # Dangerous internal API
      - "127.0.0.1:8554:8554" # RTSP from go2rtc
      - "127.0.0.1:8555:8555" # WebRTC TCP
      - "127.0.0.1:8555:8555/udp" # WebRTC UDP
    labels:
      traefik.enable: true
      traefik.http.routers.frigate.middlewares: errp-redirect@file
      traefik.http.services.frigate.loadbalancer.server.port: 8971
    environment:
      - FRIGATE_CAM1_USER=${CAM1_USER}
      - FRIGATE_CAM1_PASSWORD=${CAM1_PASSWORD}
    depends_on:
      - mosquitto

  grdf:
    image: ssenart/gazpar2mqtt:latest
    volumes:
      - ./grdf/log:/app/log
    environment:
      - GRDF_USERNAME
      - GRDF_PASSWORD
      - GRDF_PCE_IDENTIFIER
      - MQTT_BROKER=mosquitto
    depends_on:
      - mosquitto

  # grafana:
  #   image: grafana/grafana:latest
  #   volumes:
  #     - grafana_data:/var/lib/grafana
  #   labels:
  #     traefik.enable: true
  #     traefik.http.routers.grafana.middlewares: errp-redirect@file
  #     traefik.http.services.grafana.loadbalancer.server.port: 3000

  # loki:
  #   image: grafana/loki
  #   volumes:
  #     - loki_data:/loki
  #     - ./loki/config.yaml:/etc/loki/local-config.yaml:ro

  # promtail:
  #   image: grafana/promtail:latest
  #   volumes:
  #     - ./traefik/logs/:/var/log:ro
  #     - ./promtail/config.yml:/etc/promtail/config.yml:ro

  cs:
    image: crowdsecurity/crowdsec:latest-debian
    volumes:
      - crowdsec_data:/var/lib/crowdsec/data
      - ./cs/config:/etc/crowdsec
      # Logs
      - ./traefik/logs:/logs/traefik:ro
      - /var/log/journal:/run/log/journal:ro
    ports:
      - 127.0.0.1:8080:8080 # For firewall bouncer decisions
    environment:
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/traefik crowdsecurity/sshd

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./streaming/movies:/movies
      - ./streaming/downloads:/downloads
      - radarr_data:/config
    labels:
      traefik.enable: true
      traefik.http.routers.radarr.middlewares: errp-redirect@file
      traefik.http.services.radarr.loadbalancer.server.port: 7878
    profiles:
      - stream
    depends_on:
      - qbt
      - prowlarr

  qbt:
    image: lscr.io/linuxserver/qbittorrent:latest
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./streaming/downloads:/downloads
      - qbt_config:/config
    profiles:
      - stream
    labels:
      traefik.enable: true
      traefik.http.routers.qbt.middlewares: errp-redirect@file
      traefik.http.services.qbt.loadbalancer.server.port: 8080

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - prowlarr_config:/config
    profiles:
      - stream
    labels:
      traefik.enable: true
      traefik.http.routers.prowlarr.middlewares: errp-redirect@file
      traefik.http.services.prowlarr.loadbalancer.server.port: 9696

volumes:
  vw_data:
  portainer_data:
  traefik_certs:
  loki_data:
  grafana_data:
  crowdsec_data:
  radarr_data:
  qbt_config:
  prowlarr_config:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_IP}
