# Connexion SSH au Shutle

> Connexion entre shutle (mini ordi debian) et mac via ethernet uniquement (pas d'internet)

## Prérequis

1. Branchement doit être bon (pas d’ethernet débranché)
2. Activer le port réseau
   1. Vérifier laquelle des carte est utilisée via `ip a`
   2. Activer le port ethernet lié via `nmtui` (network-manager doit être installé)
3. Configurer le hostname via nmtui

## Solution 1 : partage internet

La 1ere solution consiste à partager internet du mac au shuttle afin de le lier au même réseau. Cependant cette solution ne permet pas une réelle isolation en réseau local exclusif.

1. Paramètres > Partage Internet
2. Source : connexion internet à partager (ex: wifi)
3. Destination : port utilisé pour l’ethernet

## Solution 2 : serveur DHCP

La 2e solution consiste à créer un sous réseau grâce à un serveur DHCP (dnsmasq) hébergé sur le mac. Ce serveur a pour but d'écouter les connexions entrantes sur un périphérique défini et d'adresser une adresse dynamiquement dans une plage définie à l'appareil le demandant.

1. **Identifier l'interface Ethernet du Mac**

   - Lire l’adresse MAC directement sur l’adaptateur Ethernet utilisé.
   - Utiliser `ip a` pour retrouver l’interface associée et repérer son adresse IPv4 (champ `inet`) correspondant à cette adresse MAC.

2. **Configurer dnsmasq sur le Mac**

   - Installation : `brew install dnsmasq`
   - Configuration `/opt/homebrew/etc/dnsmasq.conf` :

     ```ini
     # Nom de l'interface à écouter (identifiée précédemment)
     interface=<nom_interface>
     # Désactiver le DNS pour n'utiliser que le DHCP
     port=0
     # Configuration DHCP
     dhcp-authoritative
     dhcp-range=192.168.10.50,192.168.10.150,255.255.255.0,24h
     # Définir la passerelle par défaut (l'adresse IP du Mac)
     dhcp-option=3,192.168.10.1
     ```

   > Note : La plage 192.168.10.x est recommandée car réservée aux réseaux privés et peu utilisée par défaut, évitant ainsi les conflits.

   - Redémarrer le service :

     ```bash
     sudo brew services restart dnsmasq
     ```

   - Pour du débogage en temps réel, on peut stopper le service et lancer `dnsmasq` manuellement :

     ```bash
     sudo dnsmasq --no-daemon --log-dhcp
     ```

3. **Configurer manuellement l'IP du Mac sur son interface Ethernet**

   - Configurer l'IP statique dans "Réglages" > "Réseau" > nom de l'adaptateur ethernet > "TCP/IP" > "Configurer IPv4" : Manuellement
   - Adresse IP : 192.168.10.1 (doit correspondre à la gateway définie dans dhcp-option)

4. **Configurer le Shuttle comme client DHCP**
   - Activer le client DHCP sur l’interface réseau du Shuttle correspondant au port Ethernet utilisé.
   - Connecter le câble Ethernet entre le Mac et le Shuttle.
   - Une fois branché, le Shuttle devrait automatiquement demander une IP au Mac (via `dnsmasq`).
   - Les logs du `dnsmasq` en mode synchrone permettent de voir les requêtes DHCP entrantes et de diagnostiquer les éventuelles erreurs d’attribution.

## Deboggage

1. Rebrancher l’ethernet si les parametres du Mac sont modifiés (internet partagé, wifi changé)
2. Vérifier sur le Mac dans Paramètres > Internet que la connexion apparaisse

## Configuration SSH

Le Shuttle étant accessible via SSH depuis l'extérieur, on se doit de le protéger. Pour ce faire :

1. Installation du service fail2ban (pour protéger du brut force) : `sudo apt install fail2ban`
2. Surcharger la configuration SSH : `sudo nano /etc/ssh/sshd_config.d/custom-config.conf`
3. Copier dans celui-ci le fichier `configs/ssh.conf`
4. Redémarrer le service SSH :

   ```bash
   sudo systemctl restart sshd
   ```

## Configuration réseau externe (DNS et Freebox)

### 1. Configuration IP fixe

1. Obtenir une IP fixe :

   - Se connecter sur <https://adsl.free.fr>
   - Aller dans "Ma Freebox"
   - "Demander une adresse IP fixe V4 full-stack"

2. Vérifier l'IP publique :
   - Aller dans "État de la Freebox"
   - Noter l'adresse IPv4 publique

### 2. Redirection des ports

Sur <http://mafreebox.freebox.fr> :

- Rediriger les ports suivants vers l'IP locale du Shuttle :
  - 22 (SSH)
  - 80 (HTTP)
  - 443 (HTTPS)

### 3. Configuration DNS

1. Configuration OVH :

   - Pointer le domaine vers l'IP publique de la Freebox
   - Ajouter l'enregistrement wildcard : `*.<domaine> A <ip_publique>`

2. Optimisation DNS Freebox (pour que la propagation soit plus rapide, à cause du caching DNS de la Freebox) :

   - Aller dans "Paramètres de la Freebox > DHCP > DNS"
   - Ajouter en début de liste :
     1. 8.8.8.8 (Google)
     2. 1.1.1.1 (Cloudflare)

   > Le nom de domaine sera alors directement résolu via Google, sans passer par le système de la boxe qui est inadapté au développement.  
   > Pour vérifier la propagation DNS : utiliser <www.whatsmydns.net>. Il permet de voir la destination en temps réel d'un IP, sans la latence de la mise à jour du cache des DNS intermédiaires.
